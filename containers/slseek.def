Bootstrap: docker
From: ubuntu:22.04

%labels
    Author Beatriz Rodrigues-Estevam bia.estevam.25@gmail.com
    Version 1.0.0 (Nov-2025)
    Description "Singularity image for the SLseek pipeline (Spliced Leader sequence discovery)."
    Nextflow-Pipeline SLseek

%environment
    # Base PATH
    export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    
    # Conda paths
    export MINICONDA_HOME=/opt/miniconda3
    export CONDA_ENV_PATH=$MINICONDA_HOME/envs/SLseek_env
    
    # Prepend environment to PATH
    export PATH=$CONDA_ENV_PATH/bin:$MINICONDA_HOME/bin:$PATH
    
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PYTHONUNBUFFERED=1
    export PIPELINE_CONTAINER_VERSION=1.0.0

%post
    set -e

    echo "=== Installing system dependencies ==="
    apt-get update
    apt-get install -y --no-install-recommends \
        wget \
        build-essential \
        git \
        bzip2 \
        ca-certificates \
        liblzma-dev \
        libbz2-dev \
        zlib1g-dev \
        libncurses5-dev \
        libncursesw5-dev \
        libssl-dev \
        libcurl4-gnutls-dev \
        libxml2-dev \
        libffi-dev \
        zlib1g \
        && apt-get clean

    echo "=== Installing Miniconda ==="
    MINICONDA_HOME="/opt/miniconda3"
    MINICONDA_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh"

    wget $MINICONDA_URL -O miniconda.sh
    bash miniconda.sh -b -p $MINICONDA_HOME
    rm miniconda.sh

    echo "=== Creating Conda environment ==="
    bash -c "
        source /opt/miniconda3/etc/profile.d/conda.sh
        
        conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
        conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

        conda config --set auto_activate_base false

        conda create -y --name SLseek_env -c bioconda -c conda-forge -c defaults \
            python=3.10 \
            jellyfish \
            cd-hit \
            fastk \
            biopython=1.85 \
            numpy=2.2.6 \
            pandas=2.3.3 \
            scipy=1.15.3 \
            pysam=0.23.3 \
            matplotlib=3.10.7 \
            pillow=12.0.0 \
            six regex pytz packaging kiwisolver cycler fonttools \
            pyparsing patsy statsmodels tzdata

        conda activate SLseek_env

        pip install \
            pyahocorasick==2.2.0 \
            mizani==0.14.3 \
            plotnine==0.15.1 \
            argparse
    conda clean -a -y
    rm -rf /var/lib/apt/lists/*
    "

%runscript
    # Source conda setup
    . /opt/miniconda3/etc/profile.d/conda.sh
    conda activate SLseek_env

    exec "$@"

%test
    echo "--- SLseek Container Tests ---"

    . /opt/miniconda3/etc/profile.d/conda.sh
    conda activate SLseek_env

    # Test core tools
    fastk -h > /dev/null || (echo "ERROR: FastK failed." && exit 1)
    jellyfish --help > /dev/null || (echo "ERROR: Jellyfish failed." && exit 1)
    cd-hit -h > /dev/null || (echo "ERROR: CD-HIT failed." && exit 1)

    # Test Python environment
    python3 -c "import pandas, Bio, plotnine, ahocorasick, pysam; print('Python OK')" \
        || (echo 'ERROR: Python library import failed.' && exit 1)

    echo "All tests passed successfully!"

%help
    ####################################################################
    # SLseek Container (v1.0.0)
    ####################################################################
    Base OS: Ubuntu 22.04
    Environment: Conda (SLseek_env)

    Contents:
      - K-mer and clustering tools: FastK, Jellyfish, CD-HIT
      - Python 3.10 scientific stack
      - Plotnine, Biopython, PySAM, Aho-Corasick

    Usage examples:
      $ singularity exec slseek.sif jellyfish --help
      $ singularity exec slseek.sif python3 -c "import pandas; print(pandas.__version__)"

      # Run SLseek pipeline components:
      $ singularity exec slseek.sif python scriptname.py
    ####################################################################
